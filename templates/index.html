<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JoShares - Shared Music Sessions</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #181818; color: #fff; margin: 0; }
        .container { max-width: 600px; margin: 40px auto; background: #232323; border-radius: 10px; padding: 24px; box-shadow: 0 2px 12px #0008; }
        h1 { text-align: center; }
        .channel-list { display: flex; flex-wrap: wrap; justify-content: space-around; margin-bottom: 24px; }
        .channel-btn { background: #333; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1.1em; margin-bottom: 8px; }
        .channel-btn.selected { background: #1db954; }
        #player { margin: 20px 0; width: 100%; max-width: 100vw; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap; }
        .controls button { background: #1db954; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .video-info { text-align: center; margin-bottom: 10px; }
        .hidden { display: none; }
        .input-row { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .input-row input { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; min-width: 0; }
        #chat-container { background: #181818; border-radius: 8px; margin-top: 18px; padding: 12px; box-shadow: 0 1px 4px #0004; }
        #chat-messages { height: 160px; overflow-y: auto; background: #222; border-radius: 6px; padding: 8px; margin-bottom: 8px; font-size: 0.98em; }
        .chat-message { margin-bottom: 6px; }
        .chat-username { color: #1db954; font-weight: bold; margin-right: 4px; }
        #chat-input-row { display: flex; gap: 6px; }
        #chat-input { flex: 1; padding: 7px; border-radius: 4px; border: 1px solid #444; }
        #send-chat-btn { background: #1db954; color: #fff; border: none; padding: 7px 14px; border-radius: 4px; cursor: pointer; }
        #chat-reply-bar { background: #232323; border-left: 4px solid #1db954; padding: 6px 10px; margin-bottom: 6px; border-radius: 6px; font-size: 0.95em; color: #1db954; display: flex; align-items: center; }
        .reply-close { margin-left: auto; color: #fff; background: none; border: none; font-size: 1.1em; cursor: pointer; }
        .chat-reply-quote { background: #232323; border-left: 3px solid #1db954; padding: 3px 8px; border-radius: 5px; color: #1db954; font-size: 0.93em; margin-bottom: 2px; }
        .system-message { color: #aaa; font-style: italic; text-align: center; margin: 8px 0; font-size: 0.97em; }
        .chat-message .reply-btn { color: #1db954; background: none; border: none; margin-left: 8px; cursor: pointer; font-size: 0.95em; }
        #pip-btn { background: #232323; color: #1db954; border: none; border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1.3em; margin: 0 auto 10px auto; cursor: pointer; box-shadow: 0 1px 4px #0004; }
        #music-bars { display: flex; justify-content: center; align-items: flex-end; height: 32px; margin: 10px 0 0 0; gap: 3px; }
        .bar { width: 6px; background: linear-gradient(180deg, #1db954 60%, #232323 100%); border-radius: 3px; transition: height 0.2s cubic-bezier(.4,2,.6,1); }
        @media (max-width: 700px) {
            .container { max-width: 98vw; padding: 8px; }
            #player { width: 100vw; min-width: 0; }
        }
        @media (max-width: 480px) {
            .container { padding: 2vw; }
            .channel-btn { font-size: 1em; padding: 10px 10px; }
            #player { height: 180px !important; }
            .controls button { padding: 7px 8px; font-size: 0.95em; }
            #music-bars { height: 18px; }
            .bar { width: 4px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>JoShares</h1>
    <div id="channel-select">
        <h2>Select a Channel</h2>
        <div class="channel-list">
            <button class="channel-btn" data-channel="1">Channel 1</button>
            <button class="channel-btn" data-channel="2">Channel 2</button>
            <button class="channel-btn" data-channel="3">Channel 3</button>
            <button class="channel-btn" data-channel="4">Channel 4</button>
        </div>
        <div class="input-row">
            <input type="text" id="username" placeholder="Enter your username (optional)">
            <button id="join-btn">Join</button>
        </div>
    </div>
    <div id="session" class="hidden">
        <div class="video-info">
            <img id="video-thumb" src="" width="120" style="border-radius:8px;" class="hidden"><br>
            <span id="video-title"></span>
        </div>
        <div class="input-row">
            <input type="text" id="youtube-url" placeholder="Paste YouTube link here">
            <button id="load-btn">Load</button>
        </div>
        <div id="player"></div>
        <button id="pip-btn" title="Picture-in-Picture"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#1db954" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="14" rx="2"/><rect x="13" y="13" width="7" height="5" rx="1" fill="#1db954"/></svg></button>
        <div id="music-bars">
            <div class="bar" style="height:12px"></div>
            <div class="bar" style="height:18px"></div>
            <div class="bar" style="height:10px"></div>
            <div class="bar" style="height:20px"></div>
            <div class="bar" style="height:14px"></div>
        </div>
        <div class="controls">
            <button id="play-btn">Play</button>
            <button id="pause-btn">Pause</button>
        </div>
        <div id="chat-container">
            <div id="chat-reply-bar" class="hidden"></div>
            <div id="chat-messages"></div>
            <div id="chat-input-row">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <button id="send-chat-btn">Send</button>
            </div>
        </div>
        <div style="text-align:center; margin-top:10px;">
            <button id="leave-btn" style="background:#e74c3c;">Leave Channel</button>
        </div>
    </div>
</div>
<script>
let socket;
let player;
let currentChannel = null;
let currentVideoId = null;
let isSeeking = false;
let username = '';
let replyTo = null;
let musicBarsInterval = null;
let pendingSyncState = null;

function getYouTubeId(url) {
    const regExp = /^.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[1].length === 11) ? match[1] : null;
}

function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
        height: '315', width: '560',
        videoId: '',
        events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
        }
    });
}
window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

function onPlayerReady(event) {
    pipBtn.disabled = false;
    if (pendingSyncState) {
        syncToState(pendingSyncState);
        pendingSyncState = null;
    }
}

function onPlayerStateChange(event) {
    if (!currentChannel) return;
    if (event.data === YT.PlayerState.PLAYING && !isSeeking) {
        socket.emit('play', {
            channel: currentChannel,
            video_id: currentVideoId,
            timestamp: player.getCurrentTime(),
        });
        animateMusicBars(true);
    } else if (event.data === YT.PlayerState.PAUSED && !isSeeking) {
        socket.emit('pause', {
            channel: currentChannel,
            timestamp: player.getCurrentTime(),
        });
        animateMusicBars(false);
    }
}

function syncToState(state) {
    if (!state || !state.video_id) return;
    currentVideoId = state.video_id;
    player.loadVideoById(state.video_id, state.timestamp || 0);
    setVideoInfo(state.video_id);
    if (state.is_playing) {
        setTimeout(() => {
            isSeeking = true;
            player.seekTo(state.timestamp || 0, true);
            player.playVideo();
            setTimeout(() => { isSeeking = false; }, 500);
        }, 500);
    } else {
        setTimeout(() => {
            isSeeking = true;
            player.seekTo(state.timestamp || 0, true);
            player.pauseVideo();
            setTimeout(() => { isSeeking = false; }, 500);
        }, 500);
    }
    animateMusicBars(state && state.is_playing);
}

function setVideoInfo(videoId) {
    fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('video-title').textContent = data.title;
            document.getElementById('video-thumb').src = data.thumbnail_url;
            document.getElementById('video-thumb').classList.remove('hidden');
        })
        .catch(() => {
            document.getElementById('video-title').textContent = '';
            document.getElementById('video-thumb').classList.add('hidden');
        });
}

document.querySelectorAll('.channel-btn').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentChannel = btn.dataset.channel;
    };
});

document.getElementById('join-btn').onclick = () => {
    if (!currentChannel) {
        alert('Please select a channel!');
        return;
    }
    username = document.getElementById('username').value || 'Anonymous';
    document.getElementById('channel-select').classList.add('hidden');
    document.getElementById('session').classList.remove('hidden');
    if (!socket) {
        socket = io();
        socket.on('sync', syncToState);
        socket.on('play', state => {
            if (state.video_id !== currentVideoId) {
                player.loadVideoById(state.video_id, state.timestamp || 0);
                setVideoInfo(state.video_id);
            }
            isSeeking = true;
            player.seekTo(state.timestamp || 0, true);
            player.playVideo();
            setTimeout(() => { isSeeking = false; }, 500);
            animateMusicBars(true);
        });
        socket.on('pause', data => {
            isSeeking = true;
            player.pauseVideo();
            setTimeout(() => { isSeeking = false; }, 500);
            animateMusicBars(false);
        });
        socket.on('seek', data => {
            isSeeking = true;
            player.seekTo(data.timestamp || 0, true);
            setTimeout(() => { isSeeking = false; }, 500);
        });
        socket.on('change_video', syncToState);
        socket.on('chat_message', function(data) {
            addChatMessage(data.username, data.message, data.reply_to);
        });
        socket.on('system_message', function(data) {
            addSystemMessage(data.message);
        });
    }
    socket.emit('join', { channel: currentChannel, username });
};

document.getElementById('load-btn').onclick = () => {
    const url = document.getElementById('youtube-url').value;
    const videoId = getYouTubeId(url);
    if (!videoId) {
        alert('Invalid YouTube URL');
        return;
    }
    currentVideoId = videoId;
    setVideoInfo(videoId);
    socket.emit('change_video', { channel: currentChannel, video_id: videoId });
};

document.getElementById('play-btn').onclick = () => {
    if (player && currentChannel && currentVideoId) {
        socket.emit('play', {
            channel: currentChannel,
            video_id: currentVideoId,
            timestamp: player.getCurrentTime(),
        });
        player.playVideo();
        animateMusicBars(true);
    }
};

document.getElementById('pause-btn').onclick = () => {
    if (player && currentChannel) {
        socket.emit('pause', {
            channel: currentChannel,
            timestamp: player.getCurrentTime(),
        });
        player.pauseVideo();
        animateMusicBars(false);
    }
};

document.getElementById('leave-btn').onclick = () => {
    if (socket && currentChannel && username) {
        socket.emit('leave', { channel: currentChannel, username });
    }
    location.reload();
};

function addChatMessage(username, message, reply_to) {
    const chatMessages = document.getElementById('chat-messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-message';
    let replyHtml = '';
    if (reply_to && reply_to.username && reply_to.message) {
        replyHtml = `<div class='chat-reply-quote'><b>${reply_to.username}:</b> ${reply_to.message}</div>`;
    }
    msgDiv.innerHTML = `${replyHtml}<span class="chat-username">${username}:</span> ${message} <button class='reply-btn'>Reply</button>`;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    // Add reply button handler
    msgDiv.querySelector('.reply-btn').onclick = function() {
        showReplyBar(username, message);
    };
}

function addSystemMessage(message) {
    const chatMessages = document.getElementById('chat-messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'system-message';
    msgDiv.textContent = message;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showReplyBar(replyUsername, replyMessage) {
    replyTo = { username: replyUsername, message: replyMessage };
    const bar = document.getElementById('chat-reply-bar');
    bar.innerHTML = `<span>Replying to <b>${replyUsername}:</b> ${replyMessage}</span> <button class='reply-close' title='Cancel'>&times;</button>`;
    bar.classList.remove('hidden');
    bar.querySelector('.reply-close').onclick = function() {
        replyTo = null;
        bar.classList.add('hidden');
    };
}

document.getElementById('send-chat-btn').onclick = function() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (message && socket && currentChannel) {
        socket.emit('chat_message', { channel: currentChannel, username, message, reply_to: replyTo });
        input.value = '';
        replyTo = null;
        document.getElementById('chat-reply-bar').classList.add('hidden');
    }
};

document.getElementById('chat-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('send-chat-btn').click();
    }
});

function animateMusicBars(isPlaying) {
    const bars = document.querySelectorAll('.bar');
    if (isPlaying) {
        if (musicBarsInterval) return;
        musicBarsInterval = setInterval(() => {
            bars.forEach(bar => {
                bar.style.height = (10 + Math.random() * 20) + 'px';
            });
        }, 180);
    } else {
        clearInterval(musicBarsInterval);
        musicBarsInterval = null;
        bars.forEach((bar, i) => {
            bar.style.height = (12 + i * 3) + 'px';
        });
    }
}

// PiP logic
const pipBtn = document.getElementById('pip-btn');
pipBtn.disabled = true;

pipBtn.onclick = async function() {
    const iframe = document.querySelector('#player iframe');
    if (!iframe) {
        alert('Load a video before using Picture-in-Picture.');
        return;
    }
    try {
        if ('requestPictureInPicture' in document) {
            iframe.allow = (iframe.allow || '') + ' picture-in-picture';
            iframe.setAttribute('allow', iframe.allow);
            iframe.contentWindow.postMessage({ event: 'requestPiP' }, '*');
        } else {
            alert('Picture-in-Picture is not supported in this browser.');
        }
    } catch (e) {
        alert('Could not enter Picture-in-Picture mode: ' + e.message);
    }
};

// Listen for PiP request from parent (for browsers that support it)
window.addEventListener('message', async (event) => {
    if (event.data && event.data.event === 'requestPiP') {
        const videos = document.querySelectorAll('video');
        if (videos.length > 0 && document.pictureInPictureEnabled) {
            try {
                await videos[0].requestPictureInPicture();
            } catch (e) {}
        }
    }
});
</script>
</body>
</html> 